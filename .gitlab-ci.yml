# GitLab CI configuration for Next.js 14 deployment to S3 bucket cliptill.com
# Necessary variables:
# region: eu-central-1
# bucketname: cliptill.com
# DEPLOY_NOTIFICATION_TOKEN
# DEPLOY_NOTIFICATION_RECIPIENTS

default:
  image: node:18-alpine

stages:
  - build
  - deploy

# Notification script for deployment updates
.notification_script: &notification_script
  - apt-get install -y curl
  - COMMIT_MESSAGE=$(echo "$CI_COMMIT_MESSAGE" | sed 's/"/\\"/g' | tr -d '\n')
  - PIPELINE_URL=$(echo "$CI_PIPELINE_URL" | sed 's/"/\\"/g')
  - >
    curl -X POST $DEPLOY_NOTIFICATION_ENDPOINT
    -H "Content-Type: application/json"
    -d '{
          "token": "'"${DEPLOY_NOTIFICATION_TOKEN}"'",
          "appname": "'"${CI_PROJECT_NAME}"'",
          "version": "'$CI_COMMIT_SHA'",
          "message": "'"${COMMIT_MESSAGE}"'",
          "pipeline_url": "'"${PIPELINE_URL}"'",
          "deployment_time": "'"$(date -u)"'",
          "author": "'"${CI_COMMIT_AUTHOR}"'",
          "branch_name": "'"${CI_COMMIT_REF_NAME}"'",
          "environment_name": "'"${CI_ENVIRONMENT_NAME}"'",
          "recipients": "'$DEPLOY_NOTIFICATION_RECIPIENTS'"
        }'

# Stage 2: Build the Next.js project
build_project:
  stage: build
  image: node:18-alpine
  script:
    - npm install
    - npm run build


# Optional: Notifications after deploy
deploy_notification:
  stage: deploy
  script: *notification_script
  only:
    - main


production_deploy:
  stage: deploy
  variables:
    REMOTE_HOST: $REMOTE_HOST
  script:
    - ./bin/generate_commit_info.sh
    - cat commit_info.json
    - kamal version
    - kamal deploy
    - echo 'Kamal deploy done.'
    - *notification_script
  only:
    - main
  when: manual

