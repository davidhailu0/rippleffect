default:
  image: node:18-alpine
  tags:
    -  external-vps-runner

stages:
  - build
  - deploy

variables:
  DEPLOY_NOTIFICATION_ENDPOINT: "https://n0l5yvafvi.execute-api.us-east-1.amazonaws.com/default/deploy-notifications"
  DEPLOY_NOTIFICATION_RECIPIENTS: till@tillcarlos.com
  REMOTE_HOST: 49.13.236.191


.notification_script: &notification_script
  - ./bin/generate_build_info.sh > BUILD_INFO.json
  - apk add jq # TODO: This should go into the deployer image!
  - "jq '. + {token: \"'$DEPLOY_NOTIFICATION_TOKEN'\"}' BUILD_INFO.json > tmp.json && mv tmp.json BUILD_INFO.json"
  - >
    curl -X POST $DEPLOY_NOTIFICATION_ENDPOINT
    -H "Content-Type: application/json"
    -d @BUILD_INFO.json

# Stage 2: Build the Next.js project
build_project:
  stage: build
  image: node:18-alpine
  script:
    - npm install
    - npm run build

.cloudflare_preview_deploy_script: &cloudflare_preview_deploy_script
  image: node:18-alpine
  script:
    # Preview cloudflare pages before deploy on main
    - npm install
    - npm run build
    - mv out build
    - apk add curl
    - |
      DEPLOY_RESPONSE=$(curl -X POST \
        "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT_NAME}/deployments" \
        -H "Authorization: Bearer ${CF_API_TOKEN}" \
        -F "branch=${CI_COMMIT_REF_NAME}")

    # Extract preview URL and post to mattermost
    - |
      PREVIEW_URL=$(echo $DEPLOY_RESPONSE | jq -r '.result.url')
      curl -X POST -H 'Content-Type: application/json' \
        "${MATTERMOST_WEBHOOK_URL}" \
        -d "{
          \"text\": \"ðŸ” Preview deployment ready for ${CI_COMMIT_REF_NAME}:\n${PREVIEW_URL}\"
        }"

.cloudflare_deploy_script: &cloudflare_deploy_script
  image: node:18-alpine
  script:
    - npm install
    - npm run build
    - apk add curl
    - mv out build
    - |
      curl -X POST \
        "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT_NAME}/deployments" \
        -H "Authorization: Bearer ${CF_API_TOKEN}" \
        -F "branch=main" \
        -F "production_branch=true"

.deploy_script: &deploy_script
  # This includes kamal, dotenv, docker
  image: tillcarlos/kamal-deployer:latest
  tags:
    - product-deployer
  before_script:
    - uname -m
    - docker info
    - git rev-parse HEAD # Optional check to verify repository presence
    - mkdir -p ~/.ssh
    - eval $(ssh-agent -s)
    - '[ -z "$SSH_PRIVATE_KEY_BASE64" ] && { echo "Error: SSH_PRIVATE_KEY_BASE64 is empty."; exit 1; }'
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan $REMOTE_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - docker version
    - kamal version
    - echo "$PRODUCTION_KAMAL_SECRETS" > .env
    - echo "BUILD_INFO='$(./bin/generate_build_info.sh)'" >> .env
    - 'echo "${RAILS_ENV}:${RAILS_MASTER_KEY:0:3} <-- R.ENV R._MASTER_KEY"'
    - dotenv kamal deploy 
    - echo 'Kamal deploy done.'
    - *notification_script

cloudflare_preview_deploy:
  <<: *cloudflare_preview_deploy_script
  stage: deploy
  environment: production
  variables:
    CLOUDFLARE_API_TOKEN: ${CF_API_TOKEN}
    CLOUDFLARE_ACCOUNT_ID: ${CF_ACCOUNT_ID}
  except:
    - main

cloudflare_deploy:
  <<: *cloudflare_deploy_script
  stage: deploy
  environment: production
  variables:
    CLOUDFLARE_API_TOKEN: ${CF_API_TOKEN}
    CLOUDFLARE_ACCOUNT_ID: ${CF_ACCOUNT_ID}
  only:
    - main
  when: manual

production_deploy:
  <<: *deploy_script
  stage: deploy
  environment: production
  variables:
    REMOTE_HOST: 49.13.236.191
    RAILS_ENV: production
  only:
    - main
  when: manual
