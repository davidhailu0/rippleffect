default:
  image: node:18-alpine

stages:
  - build
  - deploy

variables:
  DEPLOY_NOTIFICATION_ENDPOINT: "https://n0l5yvafvi.execute-api.us-east-1.amazonaws.com/default/deploy-notifications"
  DEPLOY_NOTIFICATION_RECIPIENTS: till@tillcarlos.com


# Notification script for deployment updates
.notification_script: &notification_script
  - apt-get install -y curl
  - COMMIT_MESSAGE=$(echo "$CI_COMMIT_MESSAGE" | sed 's/"/\\"/g' | tr -d '\n')
  - PIPELINE_URL=$(echo "$CI_PIPELINE_URL" | sed 's/"/\\"/g')
  - >
    curl -X POST $DEPLOY_NOTIFICATION_ENDPOINT
    -H "Content-Type: application/json"
    -d '{
          "token": "'"${DEPLOY_NOTIFICATION_TOKEN}"'",
          "appname": "'"${CI_PROJECT_NAME}"'",
          "version": "'$CI_COMMIT_SHA'",
          "message": "'"${COMMIT_MESSAGE}"'",
          "pipeline_url": "'"${PIPELINE_URL}"'",
          "deployment_time": "'"$(date -u)"'",
          "author": "'"${CI_COMMIT_AUTHOR}"'",
          "branch_name": "'"${CI_COMMIT_REF_NAME}"'",
          "environment_name": "'"${CI_ENVIRONMENT_NAME}"'",
          "recipients": "'$DEPLOY_NOTIFICATION_RECIPIENTS'"
        }'

# Stage 2: Build the Next.js project
build_project:
  stage: build
  image: node:18-alpine
  script:
    - npm install
    - npm run build
  # TODO _ REMOVE THIS ONCE PIPELINE WORKS!!!
  when: manual


production_deploy:
  stage: deploy
  image: khanhhq2k/docker-ruby:latest
  environment: production
  variables:
    REMOTE_HOST: $REMOTE_HOST
  script:
    - ./bin/generate_commit_info.sh
    - cat commit_info.json
    - gem install kamal
    - kamal version
    - kamal deploy
    - echo 'Kamal deploy done.'
    - *notification_script
  only:
    - main
  # when: manual

